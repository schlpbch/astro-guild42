---
// PdfCarousel.astro (Astro component)
// Netlify-safe build: no ?url imports from pdfjs-dist in frontmatter.
// The client logic lives in a separate ESM file that Vite can bundle normally.
//
// Install once:
//   npm i pdfjs-dist
//
// Usage on a page:
//   ---
//   import PdfCarousel from "../components/PdfCarousel.astro";
//   ---
//   <PdfCarousel src="/docs/Communities.pdf" height={640} startPage={1} />

const {
  src = "/docs/Communities.pdf",
  height = 640,
  startPage = 1,
  fit = "contain",
} = Astro.props as {
  src?: string;
  height?: number;
  startPage?: number; // 1-based
  fit?: "contain" | "cover" | "width" | "height";
};
---

<style>
  .pdf-carousel {
    position: relative;
    width: 100%;
    display: grid;
    gap: 0.75rem;
  }
  .stage {
    position: relative;
    width: 100%;
    height: var(--h);
    background: #0b0b0c;
    border-radius: 1rem;
    overflow: hidden;
    display: grid;
    place-items: center;
  }
  .stage canvas {
    max-width: 100%;
    height: auto;
    display: block;
  }
  .chrome {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }
  .btn {
    appearance: none;
    border: 0;
    background: #111;
    color: #fff;
    padding: 0.6rem 0.9rem;
    border-radius: 0.9rem;
    cursor: pointer;
    font-size: 0.95rem;
  }
  .btn[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .meta {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    color: #bbb;
    font-size: 0.9rem;
  }
  .pager {
    font-variant-numeric: tabular-nums;
  }
  .scrub {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: #2a2a2e;
    outline: none;
  }
  .scrub::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
    box-shadow: 0 0 0 2px #111;
  }
  .scrub::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
    box-shadow: 0 0 0 2px #111;
  }
  .top-right {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    gap: 0.5rem;
  }
  .pill {
    background: rgba(255, 255, 255, 0.08);
    color: #eee;
    padding: 0.35rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
  }
  .error {
    position: absolute;
    inset: auto 0 0 0;
    padding: 0.5rem 1rem;
    background: #c1121f;
    color: #fff;
    font-size: 0.9rem;
    display: none;
  }
</style>

<div
  class="pdf-carousel"
  style={`--h:${height}px`}
  data-src={src}
  data-start={startPage}
  data-fit={fit}
>
  <div class="stage" id="stage" aria-live="polite">
    <div class="top-right">
      <span class="pill" id="zoomLabel">100%</span>
      <a class="pill" href={src} download>Download</a>
    </div>
    <canvas id="pageCanvas"></canvas>
    <div id="errorMsg" class="error">
      Failed to load/render PDF. Check the console for details and verify the
      path (<code>{src}</code>).
    </div>
  </div>

  <input
    class="scrub"
    id="scrubber"
    type="range"
    min="1"
    value="1"
    step="1"
    aria-label="Select page"
  />

  <div class="chrome">
    <div class="left">
      <button class="btn" id="prevBtn" aria-label="Previous page">⟨</button>
      <button class="btn" id="nextBtn" aria-label="Next page">⟩</button>
    </div>
    <div class="meta">
      <span class="pager"
        ><span id="pageNum">1</span>/<span id="pageCount">-</span></span
      >
      <button class="btn" id="zoomOut" aria-label="Zoom out">−</button>
      <button class="btn" id="zoomIn" aria-label="Zoom in">＋</button>
      <button class="btn" id="fitBtn" aria-label="Toggle fit mode">Fit</button>
    </div>
  </div>
</div>

<!-- Load pdf.js from CDN -->
<script
  is:inline
  src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs"
  type="module"></script>
<script is:inline type="module">
  const PDFJS_VERSION = "4.4.168";

  // Wait for pdf.js to be available
  async function waitForPdfJs() {
    // Import pdf.js as ES module from CDN
    const pdfjsLib =
      await import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs");
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.worker.min.mjs`;
    return pdfjsLib;
  }

  async function initPdfCarousel() {
    const host = document.querySelector(".pdf-carousel");
    if (!host) return;

    const data = host.dataset || {};
    const src = data.src || "";
    const start = parseInt(data.start || "1", 10) || 1;
    let fit = data.fit || "contain";

    const stage = host.querySelector("#stage");
    const canvas = host.querySelector("#pageCanvas");
    if (!stage || !canvas) {
      console.error("[PdfCarousel] missing stage/canvas");
      return;
    }
    const ctx = canvas.getContext("2d");
    const pageNumEl = host.querySelector("#pageNum");
    const pageCountEl = host.querySelector("#pageCount");
    const scrub = host.querySelector("#scrubber");
    const prevBtn = host.querySelector("#prevBtn");
    const nextBtn = host.querySelector("#nextBtn");
    const zoomInBtn = host.querySelector("#zoomIn");
    const zoomOutBtn = host.querySelector("#zoomOut");
    const zoomLabel = host.querySelector("#zoomLabel");
    const fitBtn = host.querySelector("#fitBtn");
    const errorMsg = host.querySelector("#errorMsg");

    let pdfDoc = null;
    let currentPage = start;
    let zoom = 1;
    let rendering = false;
    let pendingPage = null;

    const fitScaleFor = viewport => {
      const r = stage.getBoundingClientRect();
      if (r.width === 0 || r.height === 0) return 1;
      switch (fit) {
        case "width":
          return r.width / viewport.width;
        case "height":
          return r.height / viewport.height;
        case "cover":
          return Math.max(r.width / viewport.width, r.height / viewport.height);
        case "contain":
        default:
          return Math.min(r.width / viewport.width, r.height / viewport.height);
      }
    };

    const renderPage = async num => {
      if (!pdfDoc) return;
      if (rendering) {
        pendingPage = num;
        return;
      }
      rendering = true;
      try {
        const page = await pdfDoc.getPage(num);
        const baseVp = page.getViewport({ scale: 1 });
        const scale = fitScaleFor(baseVp) * zoom;
        const vp = page.getViewport({ scale });
        if (vp.width <= 1 || vp.height <= 1) {
          rendering = false;
          return;
        }
        canvas.width = Math.floor(vp.width);
        canvas.height = Math.floor(vp.height);
        await page.render({ canvasContext: ctx, viewport: vp }).promise;
        pageNumEl.textContent = String(num);
        prevBtn.disabled = num <= 1;
        nextBtn.disabled = num >= pdfDoc.numPages;
      } catch (e) {
        console.error("[PdfCarousel] render error:", e);
      }
      rendering = false;
      if (pendingPage !== null) {
        const p = pendingPage;
        pendingPage = null;
        renderPage(p);
      }
    };

    const queueRenderPage = num => {
      if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;
      currentPage = num;
      scrub.value = String(num);
      renderPage(num);
    };

    const updateZoomLabel = () => {
      zoomLabel.textContent = Math.round(zoom * 100) + "%";
    };

    // Load pdf.js and initialize
    let pdfjsLib;
    try {
      pdfjsLib = await waitForPdfJs();
    } catch (e) {
      console.error("[PdfCarousel] failed to load pdf.js:", e);
      if (errorMsg) errorMsg.style.display = "block";
      return;
    }

    try {
      pdfDoc = await pdfjsLib.getDocument(src).promise;
      if (errorMsg) errorMsg.style.display = "none";
    } catch (e) {
      console.error("[PdfCarousel] getDocument failed for", src, e);
      if (errorMsg) errorMsg.style.display = "block";
      return;
    }

    pageCountEl.textContent = String(pdfDoc.numPages);
    scrub.max = String(pdfDoc.numPages);
    scrub.value = String(Math.min(Math.max(1, start), pdfDoc.numPages));
    currentPage = parseInt(scrub.value, 10);
    updateZoomLabel();
    await renderPage(currentPage);

    // Controls
    prevBtn.addEventListener("click", () => queueRenderPage(currentPage - 1));
    nextBtn.addEventListener("click", () => queueRenderPage(currentPage + 1));
    scrub.addEventListener("input", e =>
      queueRenderPage(parseInt(e.target.value, 10))
    );
    zoomInBtn.addEventListener("click", () => {
      zoom = Math.min(zoom * 1.2, 6);
      updateZoomLabel();
      renderPage(currentPage);
    });
    zoomOutBtn.addEventListener("click", () => {
      zoom = Math.max(zoom / 1.2, 0.2);
      updateZoomLabel();
      renderPage(currentPage);
    });
    fitBtn.addEventListener("click", () => {
      const modes = ["contain", "cover", "width", "height"];
      const idx = modes.indexOf(fit);
      fit = modes[(idx + 1) % modes.length];
      renderPage(currentPage);
    });

    // Keyboard
    window.addEventListener("keydown", e => {
      if (e.key === "ArrowRight" || e.key === "PageDown") {
        e.preventDefault();
        queueRenderPage(currentPage + 1);
      }
      if (e.key === "ArrowLeft" || e.key === "PageUp") {
        e.preventDefault();
        queueRenderPage(currentPage - 1);
      }
    });

    // Resize
    const ro = new ResizeObserver(() => renderPage(currentPage));
    ro.observe(stage);
  }

  // Start when DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initPdfCarousel);
  } else {
    initPdfCarousel();
  }
</script>
